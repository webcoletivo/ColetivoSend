// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String     @id @default(cuid())
  name              String
  email             String     @unique
  image             String?    // Avatar URL
  passwordHash      String?
  googleOauthId     String?    @unique
  emailVerifiedAt   DateTime?
  twoFactorEnabled  Boolean    @default(false)
  twoFactorSecret   String?    // Encrypted TOTP secret
  recoveryCodes     String?    // Encrypted JSON array of recovery codes
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  transfers         Transfer[]
  sessions          Session[]
  trustedDevices    TrustedDevice[]
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model TrustedDevice {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash String   @unique
  userAgent String?
  ipAddress String?
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([tokenHash])
}

model Transfer {
  id              String   @id @default(cuid())
  ownerUserId     String?
  owner           User?    @relation(fields: [ownerUserId], references: [id], onDelete: Cascade)
  senderName      String
  recipientEmail  String?
  message         String?
  shareToken      String   @unique // Random, non-sequential token for sharing
  expiresAt       DateTime
  passwordHash    String?  // Optional password protection (logged users only)
  status          String   @default("active") // active, expired, revoked, deleted
  cleanupStatus   String   @default("pending") // pending, done, failed
  viewCount       Int      @default(0)
  downloadCount   Int      @default(0)
  totalSizeBytes  Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  files           File[]

  @@index([shareToken])
  @@index([ownerUserId])
  @@index([status])
  @@index([expiresAt])
}

model File {
  id           String   @id @default(cuid())
  transferId   String
  transfer     Transfer @relation(fields: [transferId], references: [id], onDelete: Cascade)
  originalName String
  mimeType     String
  sizeBytes    Int
  storageKey   String   // Path in storage (S3 key or local path)
  checksum     String?  // MD5 or SHA256 for integrity
  createdAt    DateTime @default(now())
  deletedAt    DateTime?

  @@index([transferId])
}

model GuestUsage {
  id                    String   @id @default(cuid())
  fingerprintHash       String   @unique
  ipHash                String
  transfersCreatedCount Int      @default(0)
  firstSeenAt           DateTime @default(now())
  lastSeenAt            DateTime @updatedAt

  @@index([fingerprintHash])
  @@index([ipHash])
}

model RateLimit {
  id        String   @id @default(cuid())
  key       String   @unique // IP or user ID + action
  count     Int      @default(0)
  expiresAt DateTime

  @@index([key])
  @@index([expiresAt])
}
